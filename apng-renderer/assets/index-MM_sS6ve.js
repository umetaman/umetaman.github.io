(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const c of s)if(c.type==="childList")for(const i of c.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function e(s){const c={};return s.integrity&&(c.integrity=s.integrity),s.referrerPolicy&&(c.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?c.credentials="include":s.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function n(s){if(s.ep)return;s.ep=!0;const c=e(s);fetch(s.href,c)}})();const g=[137,80,78,71,13,10,26,10];var m=(r=>(r[r.None=0]="None",r[r.Background=1]="Background",r[r.Previous=2]="Previous",r))(m||{}),y=(r=>(r[r.Source=0]="Source",r[r.Over=1]="Over",r))(y||{});const D=r=>r.slice(0,g.length).every((e,n)=>e===g[n]),F=r=>{if(D(r)==!1)throw new Error("This is not PNG");const t=new DataView(r.buffer),e=[];let n=g.length;for(;n<r.length;){const s=t.getUint32(n);n+=4;const c=t.buffer.slice(n,n+4),i=String.fromCharCode(...new Uint8Array(c));n+=4;const o=r.slice(n,n+s);n+=s;const d=r.slice(n,n+4);switch(n+=4,i){case"IHDR":const u=N(o);e.push({length:s,type:i,content:u,crc:d});break;case"IDAT":const p={data:o};e.push({length:s,type:i,content:p,crc:d});break;case"acTL":const x=R(o);e.push({length:s,type:i,content:x,crc:d});break;case"fcTL":const T=V(o);e.push({length:s,type:i,content:T,crc:d});break;case"fdAT":const A=C(o);e.push({length:s,type:i,content:A,crc:d});break;default:e.push({length:s,type:i,content:o,crc:d})}}return e},N=r=>{const t=new DataView(r.buffer),e=t.getUint32(0),n=t.getUint32(4),s=t.getUint8(8),c=t.getUint8(9),i=t.getUint8(10),o=t.getUint8(11),d=t.getUint8(12);return{width:e,height:n,bitDepth:s,colorType:c,compressionMethod:i,filterMethod:o,interlaceMethod:d}},R=r=>{const t=new DataView(r.buffer),e=t.getUint32(0),n=t.getUint32(4);return{numFrames:e,numPlays:n}},V=r=>{const t=new DataView(r.buffer),e=t.getUint32(0),n=t.getUint32(4),s=t.getUint32(8),c=t.getUint32(12),i=t.getUint32(16),o=t.getUint16(20),d=t.getUint16(22),u=t.getUint8(24),p=t.getUint8(25);return{sequenceNumber:e,width:n,height:s,xOffset:c,yOffset:i,delayNum:o,delayDen:d,disposeOp:u,blendOp:p}},C=r=>({sequenceNumber:new DataView(r.buffer).getUint32(0),data:r.slice(4)}),O=3988292384,E=new Uint32Array(256);for(let r=0;r<256;r++){let t=r;for(let e=0;e<8;e++)(t&1)===1?t=t>>>1^O:t=t>>>1;E[r]=t}const f=r=>{let t=4294967295;for(let e=0;e<r.length;e++)t=t>>>8^E[(t^r[e])&255];return t=t^4294967295,t},v=4,P=13,S=(r,t)=>{const e={...r};return e.width=t.width,e.height=t.height,e},B=r=>{r.set(g,0)},U=r=>new Uint8Array(r.split("").map(t=>t.charCodeAt(0))),M=(r,t,e)=>{const n=new DataView(r.buffer);n.setUint32(e,P),e+=4,r.set(U("IHDR"),e),e+=4,n.setUint32(e,t.width),e+=4,n.setUint32(e,t.height),e+=4,n.setUint8(e,t.bitDepth),e+=1,n.setUint8(e,t.colorType),e+=1,n.setUint8(e,t.compressionMethod),e+=1,n.setUint8(e,t.filterMethod),e+=1,n.setUint8(e,t.interlaceMethod),e+=1;const s=f(r.slice(e-P-v,e));n.setUint32(e,s)},H=(r,t,e)=>{const n=new DataView(r.buffer);n.setUint32(e,t.length),e+=4,r.set(U("IDAT"),e),e+=4,r.set(t,e),e+=t.length;const s=f(r.slice(e-t.length-v,e));n.setUint32(e,s)},G=(r,t)=>{const e=new DataView(r.buffer);e.setUint32(t,0),t+=4,r.set(U("IEND"),t),t+=4;const n=f(r.slice(t-v,t));e.setUint32(t,n)},q=r=>{const t=45+r.data.length+12;return new Uint8Array(t)};class _{chunks;numFrames=0;numPlays=0;ihdr;frames=[];get playCount(){return this.numPlays}get frameCount(){return this.numFrames}constructor(t){if(this.chunks=F(t),!this.chunks)throw new Error("Failed to read chunks");if(this.chunks[0].type!=="IHDR")throw new Error("IHDR not found");this.ihdr=this.chunks[0].content;const e=this.chunks.find(c=>c.type==="acTL");if(!e)throw new Error("acTL not found");const n=e.content;this.numFrames=n.numFrames,this.numPlays=n.numPlays;let s={control:void 0,content:void 0};for(let c=0;this.chunks[c].type!=="IEND";c++){const i=this.chunks[c];i.type=="fcTL"&&(s.control=i.content),i.type=="fdAT"&&(s.content=i.content),i.type=="IDAT"&&(s.content=i.content),s.control&&s.content&&(this.frames.push(s),s={})}console.assert(this.frames.length==this.numFrames)}createCanvasElement(){const t=document.createElement("canvas");return t.width=this.ihdr.width,t.height=this.ihdr.height,t}dispose(t,e){const n=e.getContext("2d");if(!n)throw new Error("Failed to get 2d context");if(t<1)return;const s=Math.max(0,t-1),c=this.frames[t],i=this.frames[s];switch(c.control.disposeOp){case m.None:break;case m.Background:n.clearRect(0,0,n.canvas.width,n.canvas.height);break;case m.Previous:i.image&&n.drawImage(i.image,i.control.xOffset,i.control.yOffset);break}}blend(t,e){const n=e.getContext("2d");if(!n)throw new Error("Failed to get 2d context");if(t<1){n.clearRect(0,0,n.canvas.width,n.canvas.height);return}const s=Math.max(0,t-1),c=this.frames[t],i=this.frames[s];switch(c.control.blendOp){case y.Source:n.clearRect(0,0,n.canvas.width,n.canvas.height);break;case y.Over:i.image&&n.drawImage(i.image,i.control.xOffset,i.control.yOffset);break}}renderFrame(t,e){const n=this.frames[t],s=n.image;if(!s)throw new Error("Image not loaded");const c=e.getContext("2d");if(!c)throw new Error("Failed to get 2d context");c.drawImage(s,n.control.xOffset,n.control.yOffset)}async loadAsync(){const t=[];for(let e=0;e<this.frames.length;e++){const n=this.frames[e];if(n.content){const s=this.buildPNG(n.control,n.content),c=new Blob([s],{type:"image/png"}),i=URL.createObjectURL(c),o=new Image;o.src=i;const d=new Promise(u=>{o.onload=()=>{n.image=o,u()}});t.push(d)}}await Promise.all(t)}buildPNG(t,e){const n=q(e),s=S(this.ihdr,t);let c=0;return B(n),c+=8,M(n,s,c),c+=25,H(n,e.data,c),c+=8+e.data.length+4,G(n,c),n}}class I{renderer;canvas;index=0;isPlaying=!1;constructor(t,e){this.renderer=t,this.canvas=e}play(t){if(this.isPlaying)return;this.isPlaying=!0;let e=performance.now();const n=1e3/t,s=()=>{if(!this.isPlaying)return;const c=performance.now();c-e>=n&&(this.renderer.dispose(this.index,this.canvas),this.renderer.blend(this.index,this.canvas),this.renderer.renderFrame(this.index,this.canvas),this.index=(this.index+1)%this.renderer.frameCount,e=c),requestAnimationFrame(s)};requestAnimationFrame(s)}stop(){this.isPlaying=!1,this.index=0}pause(){this.isPlaying=!1}}const L=""+new URL("apng-Cy0aw9uM.png",import.meta.url).href,j=await fetch(L),Y=new Uint8Array(await j.arrayBuffer()),w=new _(Y);await w.loadAsync();const Z=document.getElementById("sample-apng");Z.src=L;const b=document.getElementById("renderer-fps");let a=new I(w,b);a.play(30);let l=30;const $=document.getElementById("renderer-play"),z=document.getElementById("renderer-pause"),K=document.getElementById("renderer-stop"),J=document.getElementById("renderer-restart");$.addEventListener("click",()=>{a==null||a.play(l)});z.addEventListener("click",()=>{a==null||a.pause()});K.addEventListener("click",()=>{a==null||a.stop()});J.addEventListener("click",()=>{a==null||a.pause(),a=null,a=new I(w,b),a==null||a.play(l)});const h=document.getElementById("renderer-slider-fps");h.min="1";h.max="120";h.value=l.toString();const k=document.getElementById("renderer-fps-text");k.textContent=`FPS: ${l}`;h.addEventListener("input",()=>{l=parseInt(h.value,10),k.textContent=`FPS: ${l}`});h.addEventListener("change",()=>{a==null||a.pause(),a=null,a=new I(w,b),a.play(l)});
